name: Nightly Tests

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests (requires AWS credentials)'
        required: false
        default: 'true'
        type: boolean
      run_integration:
        description: 'Run integration tests'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read
  issues: write

env:
  GOPRIVATE: github.com/rshade/*
  GO_VERSION: '1.25.5'

jobs:
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_integration == 'true' }}
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build plugin binaries for integration tests
        run: |
          if [ -d "examples/plugins/aws-example" ]; then
            go build -o bin/aws-example-plugin ./examples/plugins/aws-example
          fi

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          go test -v -timeout 20m ./test/integration/...

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            test/integration/*.log
          retention-days: 7

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || github.event.inputs.run_e2e == 'true' }}
    timeout-minutes: 90
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install Pulumi CLI
        uses: pulumi/actions@v6
        with:
          pulumi-version: latest

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Build pulumicost binary
        run: make build

      - name: Run E2E tests
        env:
          AWS_REGION: us-east-1
          E2E_REGION: us-east-1
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE || 'e2e-test-passphrase' }}
          E2E_TIMEOUT_MINS: '60'
          PULUMICOST_LOG_LEVEL: debug
          PULUMICOST_LOG_FORMAT: console
          PULUMICOST_BINARY: ${{ github.workspace }}/bin/pulumicost
        run: |
          cd test/e2e
          go test -v -tags e2e -timeout 60m ./...

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            test/e2e/*.log
          retention-days: 7

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [integration, e2e]
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Nightly test failure - ${new Date().toISOString().split('T')[0]}`;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Check if an issue already exists for today
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'nightly-failure',
              state: 'open'
            });

            const todayIssue = existingIssues.data.find(issue =>
              issue.title.includes(new Date().toISOString().split('T')[0])
            );

            if (todayIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `Another nightly run failed: ${runUrl}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: `## Nightly Test Failure\n\nThe nightly test run has failed.\n\n**Run URL:** ${runUrl}\n\nPlease investigate and fix the failing tests.`,
                labels: ['nightly-failure', 'bug']
              });
            }
